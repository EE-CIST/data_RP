# Importation

```{r, echo=FALSE}
library(knitr)
library(data.table)
library(readxl)
```


La première étape du travail est d'importer les fichiers dont nous aurons besoin à partir du sute IPUMS International. L'ensemble des données utilisées dans cet exercice sera téléchargée sur le site [IPUMS international](https://international.ipums.org/international/index.shtml) :

![ipums homepage](img/ipums_001.png)

## Conditions d'utilisation

Les données fournies par IPUMS sont soumises à des [conditions d'utilisation](https://international.ipums.org/international/terms.shtml) qui doivent être respectées et que nous avons retraduites ici en français (merci à google translate).

### Redistribution interdite

> *"Toutes les données extraites de la base de données IPUMS International sont destinées au seul usage du licencié. En vertu des accords d'IPUMS International avec des agences collaboratrices, la redistribution des données à des tiers est interdite. Chaque membre d'une équipe de recherche utilisant les données doit demander l'accès et obtenir une licence individuelle"*.

-   **Commentaire** : l'ensemble des participants à l'école d'été devra donc acquérir une licence individuelle IPUMS et sera réputé avoir effectué l'ensemble des opérations d'acquisitions décrites par la suite.

### Usage : Limitation à la recherche et l'enseignement

> *"Ces extraits de microdonnées sont fournis à des fins exclusives d'enseignement et de recherche scientifique et ne peuvent être utilisés à d'autres fins sans l'approbation écrite explicite de l'autorité statistique officielle compétente. Il est interdit aux utilisateurs d'utiliser les données d'IPUMS International ou d'autres distributeurs autorisés dans la poursuite de toute entreprise commerciale ou génératrice de revenus, à titre privé ou autre. La publication de résultats de recherche basés sur les microdonnées d'IPUMS International est autorisée dans les communications telles que les articles scientifiques, les revues, les rapports de recherche, etc. L'utilisation de ces données à des fins généalogiques est strictement interdite"*

-   **Commentaire** : Les objectifs de l'EE CIST 2023 sont parfaitement en accord avec les règles d'usage de la base. Il faudra toutefois bien prendre garde de citer la source dans l'ensemble des documents pédagogiques ainsi que les éventuels articles de recherche

### Confidentialité : interdiction d'identifier des individus

> *"Les utilisateurs maintiendront la confidentialité des personnes et des ménages. Tous les identifiants directs, ainsi que toutes les caractéristiques qui pourraient conduire à une identification, sont omis des données. Toute tentative de vérifier l'identité des personnes ou des ménages à partir des microdonnées est interdite. Il est également interdit d'alléguer qu'une personne ou un ménage a été identifié dans ces données. Les résultats statistiques susceptibles de révéler l'identité de personnes ou d'entités ne peuvent être communiqués ou publiés sous quelque forme que ce soit."*

-   **Commentaire** : Même si les données sont en général anciennes et portent sur des échantillons de 10% maximum, il est impératif de respecter systématiquement l'obligation de confidentialité et de tenter de repérer une personne si IPUMS n'a pas suffisamment assuré cette condition.

### Sécurité : protection des micro-données

> *"Les utilisateurs mettront en œuvre des mesures de sécurité pour empêcher tout accès non autorisé aux microdonnées acquises auprès d'IPUMS International, de ses partenaires ou distributeurs autorisés. À l'issue de cette recherche, les extraits de données ne peuvent être conservés que s'ils peuvent être sécurisés en toute sécurité. Si la sécurité ne peut être garantie, les microdonnées doivent être détruites."*

-   **Commentaire** : Cette obligation signifie que les données individuelles ne pourront pas être mises à disposition via le serveur de l'EE CIST 2023 sauf si celui-ci est correctement sécurisé. Il faudra les faire télécharger par les stagiaires ou formateur au moment de celle-ci. On pourra en revanche stocker les indicateurs agrégés issus de l'agrégation des données individuelles.

### Obligation de citation

> *"Vous devez citer IPUMS International et l'autorité statistique officielle compétente comme source des microdonnées. Chaque extrait est accompagné d'un langage de citation approprié et pour plus d'informations sur la citation appropriée, reportez-vous à la [citation et à l'utilisation](https://international.ipums.org/international/citation.shtml). Les publications et les rapports de recherche utilisant IPUMS International doivent être ajoutés à la \[bibliographie du projet IPUMS\] (https://bibliography.ipums.org/)."*

-   **Commentaire** : les documents pédagogiques de l'EE CIST 2023 utilisant les données IPUMS devront se conformer à cette obligation de même que les éventuels articles de recherche qui en seront issus.

### Rapports d'erreurs

> *"L'utilisateur accepte d'informer ipums\@umn.edu des erreurs dans les données"*

-   **Commentaire** : c'est la moindre des choses dans une perspective éthique et collaborative.

### Sanctions en cas de non respect

> *"La violation de cet accord entraînera la révocation de cette licence, le rappel de toutes les microdonnées acquises, une motion de censure à la ou aux organisations professionnelles concernées et des poursuites civiles en vertu des lois nationales ou internationales, à la discrétion des régents de l'Université du Minnesota. et les agences statistiques officielles. Des sanctions peuvent également être prises contre l'institution à laquelle le contrevenant est affilié.*"

-   **Commentaire** : sans commentaires ... il serait catastrophique pour le projet d'EE CIST 2023 de voir l'ensemble des cours mis à l'index ...

## Données individuelles de recensement

Après avoir créé votre compte, vous pourrez accéder à l'onglet appelé "*browse and select data*" dans la barre latérale gauche :

![lien vers les micro-données](img/ipums_002.png)

Il vous amènera à la fenêtre de sélection des micro-données qui doit ressembler à ceci :

![tableau de bord des requêtes de microdonnées](img/ipums_003.png)

Vous allez alors devoir effectuer successivement trois choix pour constituer votre requête :

-   *choix de l'échantillon* : quels recensements pour quels pays et à quelle date ?
-   *choix des variables* : quelles variables voulez vous extraire ? harmonisées ou propres au pays ?
-   *choix de la taille des échantillons* : le maximum autorisé est de 10% mais vous pouvez choisir un taux plus faible.

### Choix des recensements

En cliquant sur le bouton "*SELECT SAMPLES*" on va tout d'abord choisir les recensements qui nous intéressent. On peut en retenir soit un seul soit plusieurs à la fois. Ici, nous avons retenu cinq recensements correspondant aux pays africains qui participent à l'EE CIST 2023, en retenant à chaque fois le dernier disponible dans IPUMS.

![Recensements africains disponibles dans IPUMS International](img/ipums_004.png)

On constate qu'il n'existe malheureusement pas de données pour la Côte d'Ivoire et le Niger dans IPUMS. Par ailleurs les recensements les plus récents ne sont pas forcément disponibles pour les autres pays. Mais il existe une contrepartie positive majeure qui est le travail d'harmonistation des variables qui a été réalisé par IPUMS.

### Choix des variables

Il existe deux options différentes pour extraire des variables, selon qu'on souhaite utiliser les données originales propres à chaque pays et chaque date ("*Source variables*") ou que l'on préfère utiliser des données harmonisées par IPUMS ("*Harmonized variables*") qui utilisent les même code et les même catégories.

La seconde solution apparaît de loin la plus intéressante pour l'EE CIST 2023 puisqu'elle va permettre de proposer des séquences pédagogiques qui seront facilement reproductibles d'un pays à l'autre. A condition évidemment que les variables harmonisées soient disponibles dans tous les pays, ce qui n'est bien évidemment pas toujours vrai.

Des écrans permettent de visualiser pour chacune des variables ou des groupes de variables si elle est disponible pour les différents recensements. Les variables dites "techniques" sont proposées par défaut et il est en général préférable de les garder puisque c'est grâce à elle qu'on pourra ensuite effectuer les pondérations, mettre en relation les individus et les ménages etc. 


![Variables par défaut : ménages](img/ipums_006.png)


![Variables par défaut : individus](img/ipums_007.png)

En cliquant sur la colonne ("*Add to cart*") on choisit les autres variables que l'on souhaite retenir. Par exemple, on peut regarder quelles variables harmonisées sont disponibles pour l'équipement des ménages et en choisir trois :  

![Exemple de sélection de variables sur l'équipement des ménages](img/ipums_005.png)

Nous avons effectué une sélection assez large de variables pour l'EE CIST 2023 en privilégiant celles qui étaient disponibles pour au moins 4 des 5 pays. Nous ya vons ajouté des variables plus spécifiques à chaque pays pour l'analyse des migrations. Au total, nous avons retenu 65 variables qui sont décrites en abrégées ci-dessous mais dont on pourra trouver la description détaillée sur le site IPUMS

```{r, echo = FALSE}
selvar <- read_excel("ipums/rp/selvar.xls")
kable(selvar, caption = "Liste de variables retenus pour les 5 recensements")
```

### Choix du niveau d'échantillonage

Une fois définis les échantillons et les variables vous êtes prêts à télécharger les données mais il reste encore à définir le niveau d'échantillonnage souhaité.

![Exemple de sélection de variables sur l'équipement des ménages](img/ipums_008.png)
La valeur initiale qui correspond au maximum autorisé par IPUMS et les organismes producteurs des recensement est en générale égale à 10% des individus et/ou des ménages. Mais on peut opter pour un échantillon plus réduit en fixant un autre pourcentage ou un nombre précis d'individus. On peut par exemple se ramener à 1% seulement des observations ce qui divise par 10 la taille du fichier :  

![Exemple de réduction de la densité d'échantillonage de 10% à 1%](img/ipums_009.png)
### Récupération des données et métadonnées

Une fois lancée la requête à l'aide du bouton "*SUBMIT EXTRACT*" il faut attendre quelques minutes (généralement 2 ou 3) pour accèder au résultat. Celui-ci est annoncé par un courriel mais peut aussi être suivi directement par le navigateur : 

![Exemple de réduction de la densité d'échantillonage de 10% à 1%](img/ipums_010.png)
On peut utiliser une requête existante pour en construire une autre. Dans l'exemple ci-dessus, nous avons construit d'abord une requête pour une extraction de densité 1% puis une seconde requête pour une extraction de densité maximale (10%) afin de pouvoir comparer les résultats obtenus.

Pour pouvoir charger ensuite les données dans R ou un autre logiciel, nous aurons besoin à chaque fois de deux fichiers : 

- le fichier .DAT qui contient les données au format compressé .gz
- le fichier DDI qui contient les métadonnées au format .xml


![Récupération des fichiers IPUMS](img/ipums_011.png)

**- N.B. :** Il est inutile de décompresser les fichiers de données au format .gz car cela accroîtrait inutilement leur place et risquerait de bloquer l'opération suivante d'importation. 


### Importation dans R

Pour importer les données dans R, il faut installer le package *ipumsr* qui va nous permettre de lire les métadonnées puis d'importer les données en une seule opération. 

```{r import_ipums, echo=TRUE, eval=FALSE}
library(ipumsr)

# Importation de l'échantillon à 1%
ddi <- read_ipums_ddi("ipums/rp/ipumsi_00015.xml")
data <- read_ipums_micro(ddi)
saveRDS(data,"ipums/rp/samp1pct.RDS")

# Importation de l'échantillon à 10%
ddi <- read_ipums_ddi("ipums/rp/ipumsi_00016.xml")
data <- read_ipums_micro(ddi)
saveRDS(data,"ipums/rp/samp10pct.RDS")
```
Nous reviendrons ultérieurement sur le format du tableau R obtenu qui n'est pas un *data.frame* standard car il comporte des labels supplémentaire donnant à la fois le nom des variables et le code de leurs modalités. 


## Données géométriques de niveaux 1 et 2

